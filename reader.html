<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‚Ø§Ø±Ø¦ Ø´ÙŠÙ† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f4f1ea; --text: #2c3e50; --size: 1.3rem; --highlight: #ffff00aa; }
        body.dark-mode { --bg: #1a1a1b; --text: #d5d5d5; --highlight: #ffcc0066; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Amiri', serif; transition: 0.3s; overflow: hidden; touch-action: pan-y; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
        .toolbar { height: 60px; display: flex; align-items: center; justify-content: space-around; background: rgba(0,0,0,0.05); backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 100; }
        .btn { cursor: pointer; padding: 5px 10px; border-radius: 8px; font-family: 'Cairo'; font-size: 11px; border: 1px solid #ccc; background: white; }
        .marker-active { background: #ffcc00 !important; border-color: orange; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨ */
        #book-container { margin-top: 60px; height: calc(100vh - 110px); width: 100vw; overflow: hidden; position: relative; }
        #pages-wrapper { display: flex; transition: transform 0.4s ease; height: 100%; }
        .page { min-width: 100vw; box-sizing: border-box; padding: 20px 8%; text-align: justify; font-size: var(--size); line-height: 2; height: 100%; overflow: hidden; }

        /* Ø§Ù„Ù…Ø§Ø±ÙƒØ± */
        ::selection { background: var(--highlight); }
        .highlighted { background-color: var(--highlight); border-radius: 3px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠ */
        .status-bar { position: fixed; bottom: 0; width: 100%; height: 40px; background: rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-sizing: border-box; font-family: 'Cairo'; font-size: 12px; }
    </style>
</head>
<body class="sepia-mode">

    <div class="toolbar">
        <button class="btn" onclick="location.href='index.html'">ğŸ </button>
        <button class="btn" id="markerBtn" onclick="toggleMarker()">ğŸ–ï¸ ØªØ­Ø¯ÙŠØ¯</button>
        <button class="btn" onclick="setMode('dark')">ğŸŒ™</button>
        <button class="btn" onclick="setMode('sepia')">ğŸ“œ</button>
        <button class="btn" onclick="changeFontSize(0.1)">A+</button>
        <button class="btn" onclick="changeFontSize(-0.1)">A-</button>
    </div>

    <div id="book-container">
        <div id="pages-wrapper">
            <div class="page">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙØµÙˆÙ„ Ø§Ù„Ø±ÙˆØ§ÙŠØ©...</div>
        </div>
    </div>

    <div class="status-bar">
        <span id="page-count">ØµÙØ­Ø©: -- / --</span>
        <span id="book-title">Ø­Ù„Ù… Ø·Ù†Ø¬Ø§Ø±</span>
    </div>

    <script>
        let currentPage = 0;
        let totalPages = 0;
        let isMarkerOn = false;
        let bookID = "";

        async function initReader() {
            const params = new URLSearchParams(window.location.search);
            bookID = params.get('book');
            if(!bookID) return;

            try {
                const res = await fetch(`${bookID}.txt`);
                const text = await res.text();
                paginateText(text);
                loadProgress(); // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù„ÙŠ ÙˆÙ‚Ù Ø¹Ù†Ø¯Ù‡
            } catch(e) { console.error("Error loading book"); }
        }

        // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ù„ØµÙØ­Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©
        function paginateText(text) {
            const wrapper = document.getElementById('pages-wrapper');
            wrapper.innerHTML = "";
            const words = text.split(/\s+/);
            let currentPageText = "";
            
            // ØªÙ‚Ø³ÙŠÙ… ØªÙ‚Ø±ÙŠØ¨ÙŠ: ÙƒÙ„ ØµÙØ­Ø© 200 ÙƒÙ„Ù…Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
            for(let i=0; i<words.length; i++) {
                currentPageText += words[i] + " ";
                if(i > 0 && i % 250 === 0) {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'page';
                    pageDiv.innerHTML = currentPageText;
                    wrapper.appendChild(pageDiv);
                    currentPageText = "";
                }
            }
            // Ø¥Ø¶Ø§ÙØ© Ø¢Ø®Ø± ØµÙØ­Ø©
            if(currentPageText) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page';
                pageDiv.innerHTML = currentPageText;
                wrapper.appendChild(pageDiv);
            }
            
            totalPages = document.querySelectorAll('.page').length;
            updateUI();
        }

        function toggleMarker() {
            isMarkerOn = !isMarkerOn;
            document.getElementById('markerBtn').classList.toggle('marker-active');
            alert(isMarkerOn ? "ØªÙ… ØªÙØ¹ÙŠÙ„ Ù‚Ù„Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ¯: Ø­Ø¯Ø¯ Ø£ÙŠ Ù†Øµ Ø¨ØµØ¨Ø§Ø¹Ùƒ" : "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù‚Ù„Ù…");
        }

        function updateUI() {
            document.getElementById('page-count').innerText = `ØµÙØ­Ø©: ${currentPage + 1} / ${totalPages}`;
            document.getElementById('pages-wrapper').style.transform = `translateX(${currentPage * 100}vw)`;
            saveProgress();
        }

        // Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù„ÙŠ ÙˆÙ‚Ù Ø¹Ù†Ø¯Ù‡Ø§
        function saveProgress() {
            localStorage.setItem(`progress_${bookID}`, currentPage);
        }

        function loadProgress() {
            const saved = localStorage.getItem(`progress_${bookID}`);
            if(saved) {
                currentPage = parseInt(saved);
                updateUI();
            }
        }

        // Ø¥ÙŠÙ…Ø§Ø¡Ø§Øª Ø§Ù„Ù„Ù…Ø³
        let startX = 0;
        window.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        window.addEventListener('touchend', e => {
            let diff = startX - e.changedTouches[0].clientX;
            if(Math.abs(diff) > 50) {
                if(diff > 0 && currentPage < totalPages - 1) currentPage++;
                else if(diff < 0 && currentPage > 0) currentPage--;
                updateUI();
            }
        });

        function setMode(m) { document.body.className = m + '-mode'; }
        function changeFontSize(d) { /* Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ø· */ }

        window.onload = initReader;
    </script>
</body>
</html>
